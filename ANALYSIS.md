# Анализ проектов ND и Sigur

## Общая структура

### ND (nd/)
**Тип**: Полнофункциональная система контроля доступа с поддержкой сессий, камер, JSP терминалов
**Главный файл**: `daemon.php`
**Порт**: 8999

**Ключевые особенности**:
- Поддержка сессий с многоэтапной обработкой (KPO → CAM → PASS)
- Интеграция с камерными сервисами (Helios/Crystal)
- Поддержка JSP протокола для JavaScript терминалов
- Поддержка POCKET протокола (биометрические устройства)
- Поддержка GAT, SPHINX протоколов
- Интеграция с 1C через HTTP API
- CSV логирование событий
- Управление шкафчиками (lockers)
- Поддержка временных карт
- Система памяти регистров (memreg) для полотенец и т.д.

### Sigur (sigur/)
**Тип**: Упрощенная система контроля доступа для базовых терминалов
**Главный файл**: `gataccess_bin.php`
**Порт**: 8998

**Ключевые особенности**:
- Более простая архитектура без сессий
- Прямая обработка событий от терминалов
- Поддержка GAT, POCKET, SPHINX протоколов
- Интеграция с 1C через HTTP API
- Интеграция с MSSQL через HTTP proxy
- Поддержка соляриев (solar path)
- Логирование событий в gtime формат
- Нет поддержки JSP
- Нет поддержки камер
- Нет поддержки сессий

## Сравнительная таблица функций

| Функция | ND | Sigur | Go проект |
|---------|----|----|-----------|
| GAT протокол | ✅ | ✅ | ✅ |
| POCKET протокол | ✅ | ✅ | ✅ |
| SPHINX протокол | ✅ | ✅ | ✅ |
| JSP протокол | ✅ | ❌ | ✅ |
| Сессии | ✅ | ❌ | ✅ |
| KPO проверка | ✅ | ✅ | ✅ |
| CAM проверка | ✅ | ❌ | ✅ |
| Интеграция с 1C | ✅ | ✅ | ✅ |
| Интеграция с MSSQL | ❌ | ✅ | ❌ |
| Камерные сервисы | ✅ (Helios/Crystal) | ❌ | ✅ (Helios/Crystal) |
| CSV логирование | ✅ | ❌ | ❌ |
| GTime логирование | ❌ | ✅ | ❌ |
| Управление шкафчиками | ✅ | ✅ | ❌ |
| Временные карты | ✅ | ❌ | ❌ |
| Memreg (полотенца) | ✅ | ❌ | ❌ |
| Солярии | ❌ | ✅ | ❌ |
| Web интерфейс | ❌ | ❌ | ✅ |

## Архитектурные различия

### ND - Сессионная модель
```
Tag Read → Session Create → KPO Request → KPO Result → 
→ CAM Request (optional) → CAM Result → 
→ Open First Gate → First Passed → 
→ Open Second Gate → Second Passed → 
→ Send Report → Session Done
```

**Ключевые файлы**:
- `daemon.php` - главный файл демона
- `inl/session.inl` - управление сессиями
- `inl/jsp.inl` - JSP протокол
- `inl/pocket.inl` - POCKET протокол
- `inl/helios.inl` - интеграция с Helios
- `inl/httpr.inl` - HTTP клиент для 1C
- `inl/conn.inl` - управление соединениями

### Sigur - Прямая обработка
```
Tag Read → HTTP Request → HTTP Response → Send Command → Done
```

**Ключевые файлы**:
- `gataccess_bin.php` - главный файл демона
- `sphinx.inl` - SPHINX протокол
- Прямая обработка в `on_pocket_data()` и `on_gat_data()`

## Детальный анализ компонентов

### 1. Протоколы контроллеров доступа

Все протоколы предназначены для работы с **контроллерами доступа** (контроллерами дверей).

#### GAT (Generic Access Terminal)
- **Назначение**: Классические контроллеры доступа
- **ND**: Используется через `ga()` функцию
- **Sigur**: Используется через `ga()` функцию
- **Go**: Реализован в `internal/protocols/gat/protocol.go`

#### POCKET (EPROTO)
- **Назначение**: Биометрические контроллеры доступа
- **ND**: Полная поддержка с интерактивными сообщениями, реле, биометрией
- **Sigur**: Базовая поддержка чтения меток и управления реле
- **Go**: Реализован в `internal/protocols/pocket/protocol.go`

#### SPHINX
- **Назначение**: Контроллеры доступа Sphinx
- **ND**: Поддержка через `sphinx.inl`
- **Sigur**: Поддержка через `sphinx.inl`
- **Go**: Реализован в `internal/protocols/sphinx/protocol.go`

#### JSP (JSON Socket Protocol)
- **Назначение**: JavaScript терминалы доступа
- **ND**: Полная поддержка с auto-ping, requests, answers
- **Sigur**: Не поддерживается
- **Go**: Реализован в `internal/protocols/jsp/protocol.go`

### 2. Управление сессиями

#### ND - Сложная модель сессий
```php
// Стадии сессии:
- init (начало)
- kpo_result (результат проверки KPO)
- open_first (открытие первой двери)
- first_passed (проход через первую дверь)
- cam_result (результат проверки камеры)
- open_second (открытие второй двери)
- second_passed (проход через вторую дверь)
- kpo_direct (прямой проход без дверей)
- last_answer (финальный ответ)
- passed (проход завершен)
- done (сессия завершена)
```

**Функции**:
- `dmnh_session_cde()` - главная функция обработки сессии
- `session_set_kpo_result()` - установка результата KPO
- `session_set_cam_result()` - установка результата CAM
- `session_check_done()` - проверка завершения стадии
- `session_dev_send_pass_request()` - отправка запроса на проход
- `session_dev_send_cancel_text()` - отправка сообщения об отказе

#### Sigur - Нет сессий
Прямая обработка событий без сохранения состояния.

#### Go - Реализована модель сессий
- `internal/session/manager.go` - менеджер сессий
- `ProcessSessionStage()` - обработка стадий сессии
- Поддержка всех стадий из ND

### 3. Интеграция с внешними сервисами

#### 1C HTTP API

**ND**:
```php
// Различные форматы URL:
- 'wc1c': /path/id/uid/0/0/0/lockers/0
- '1c_m': /checkaccess?id=...&uid=...&tagtype=...
- 'a&a': /verify/id/uid
- 'craft': /pass_request?id=...&uid=...&role=...&locks=...
```

**Sigur**:
```php
// Простой формат:
- /path/id/uid/rq/bio/p1/cab1/cab2
```

**Go**: Реализовано в `internal/httpclient/client.go`
- Поддержка формата `wc1c`
- Поддержка формата `1c_m`
- `CheckAccess()` - проверка доступа
- `SendAccessReport()` - отправка отчета

#### Камерные сервисы

**ND**:
- Helios (WebSocket)
- Crystal/RecX (HTTP JSON)
- Поддержка correlation updates
- Поддержка timeout обработки

**Sigur**: Не поддерживается

**Go**: Частично реализовано
- Структура для Helios в `internal/daemon/daemon.go`
- Нужна полная реализация WebSocket клиента для Helios

#### MSSQL

**Sigur**:
```php
// Через HTTP proxy:
- /api/ExecuteSelectQuery?server=...&database=...&query=...
- Вызовы хранимых процедур:
  - [dbo].[ZD_ZONE_ACCESS]
  - [dbo].[ZD_SOLAR_SALE]
```

**ND**: Не используется напрямую

**Go**: Не реализовано

### 4. Управление соединениями

#### ND
- Поддержка множественных соединений
- Управление через `conn.inl`
- Поддержка reconnection
- Auto-ping для терминалов
- Поддержка разных типов терминалов одновременно

#### Sigur
- Аналогичная система соединений
- Reconnection механизм
- Auto-ping

#### Go
- Реализовано в `internal/connection/pool.go`
- Поддержка reconnection
- Auto-ping для JSP
- Нужен auto-ping для других протоколов

### 5. Логирование

#### ND
- CSV логирование сессий
- Бинарные логи пакетов
- Логи экрана
- Логи ошибок

#### Sigur
- GTime логирование (формат для временных событий)
- Бинарные логи пакетов
- Логи экрана

#### Go
- Структурированное логирование через `internal/logging/logger.go`
- Нет CSV логирования
- Нет GTime логирования

## Что реализовано в Go проекте

✅ **Протоколы**:
- GAT
- POCKET
- SPHINX
- JSP

✅ **Сессии**:
- Создание и управление сессиями
- Обработка стадий (KPO, CAM, PASS)
- Интеграция с HTTP клиентом

✅ **HTTP клиент**:
- Проверка доступа через 1C
- Отправка отчетов
- Поддержка разных форматов URL

✅ **Управление соединениями**:
- TCP пул соединений
- Reconnection
- Auto-ping для JSP

✅ **Web интерфейс**:
- Мониторинг демона
- Просмотр соединений
- Просмотр сессий

## Что нужно добавить/улучшить

### Высокий приоритет

1. **Auto-ping для всех протоколов**
   - Сейчас только JSP
   - Нужно для POCKET, GAT, SPHINX

2. **Полная интеграция с Helios**
   - WebSocket клиент
   - Обработка correlation updates
   - Timeout handling

3. **CSV логирование**
   - Для совместимости с ND
   - Логирование сессий

4. **Управление шкафчиками (lockers)**
   - Парсинг данных lockers из POCKET
   - Проверка deny_lockers
   - Передача в 1C

5. **Временные карты**
   - Обработка temp_card флага
   - Проверка deny_ct

### Средний приоритет

6. **GTime логирование**
   - Для совместимости с Sigur
   - Формат временных событий

7. **MSSQL интеграция**
   - HTTP proxy клиент
   - Вызов хранимых процедур
   - Для совместимости с Sigur

8. **Солярии (Solar)**
   - Отдельный путь в 1C
   - Обработка временных событий

9. **Memreg (память регистров)**
   - Управление полотенцами
   - Другие типы регистров

10. **Улучшение обработки ошибок**
    - Более детальные сообщения
    - Retry механизмы

### Низкий приоритет

11. **Proxy поддержка**
    - Для транзитных соединений

12. **UCS поддержка**
    - Для специфических терминалов

13. **TXP поддержка**
    - Для специфических терминалов

14. **CRT поддержка**
    - Для интеграции с Vizir

## Рекомендации по дальнейшей разработке

1. **Приоритизировать функциональность ND**
   - ND более функциональный и современный
   - Sigur можно использовать как reference для простых случаев

2. **Добавить тесты**
   - Unit тесты для протоколов
   - Integration тесты для сессий
   - Mock тесты для HTTP клиента

3. **Улучшить документацию**
   - API документация
   - Примеры использования
   - Описание протоколов

4. **Оптимизация производительности**
   - Connection pooling
   - Кэширование результатов
   - Асинхронная обработка

5. **Мониторинг и метрики**
   - Prometheus метрики
   - Health checks
   - Performance monitoring

## Выводы

Go проект успешно объединяет функциональность обоих PHP проектов:
- ✅ Все основные протоколы реализованы
- ✅ Сессионная модель из ND реализована
- ✅ HTTP интеграция с 1C работает
- ✅ Web интерфейс добавлен (новое)

Основные пробелы:
- ❌ Auto-ping для всех протоколов
- ❌ Полная интеграция с Helios
- ❌ CSV/GTime логирование
- ❌ Управление шкафчиками
- ❌ MSSQL интеграция (для совместимости с Sigur)

Проект готов к использованию для базовых сценариев, но требует доработки для полной совместимости с ND.

