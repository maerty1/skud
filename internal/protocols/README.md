# Протоколы контроллеров доступа

## Общее описание

Все протоколы в этой директории предназначены для работы с **контроллерами доступа** (контроллерами дверей). Каждый протокол используется для связи с определенным типом контроллера.

## Поддерживаемые протоколы

### 1. JSP (JavaScript Protocol)
- **Тип контроллера**: JavaScript терминалы доступа
- **Формат**: JSON over TCP
- **Особенности**: 
  - Современный протокол с request/response системой
  - Поддержка auto-ping
  - Интерактивные сообщения
  - Управление реле (открытие/закрытие дверей)
  - Поддержка шкафчиков (lockers)
- **Файл**: `jsp/protocol.go`
- **Документация**: `jsp/README.md`

### 2. POCKET (EPROTO)
- **Тип контроллера**: Биометрические контроллеры доступа
- **Формат**: Бинарный протокол EPROTO
- **Особенности**:
  - Поддержка RFID карт
  - Биометрическая идентификация (отпечатки пальцев)
  - Интерактивные сообщения на дисплее
  - Управление реле с таймерами
  - Поддержка шкафчиков
  - Поддержка временных карт
- **Файл**: `pocket/protocol.go`
- **Документация**: `pocket/README.md` (если есть)

### 3. GAT (Generic Access Terminal)
- **Тип контроллера**: Классические контроллеры доступа
- **Формат**: Бинарный протокол
- **Особенности**:
  - Стандартный протокол для большинства контроллеров
  - Поддержка различных типов терминалов (ACCESS, TIME)
  - Простая структура команд
  - Поддержка соляриев (solar)
- **Файл**: `gat/protocol.go`
- **Документация**: `gat/README.md` (если есть)

### 4. SPHINX
- **Тип контроллера**: Контроллеры доступа Sphinx
- **Формат**: Текстовый протокол
- **Особенности**:
  - Команды в текстовом формате
  - Поддержка делегирования
  - Специфичный для контроллеров Sphinx
- **Файл**: `sphinx/protocol.go`
- **Документация**: `sphinx/README.md` (если есть)

## Общие функции всех протоколов

Все протоколы контроллеров доступа поддерживают:

1. **Чтение RFID карт** (`tag_read`)
   - Получение UID карты
   - Проверка авторизации
   - Дополнительные данные (шкафчики, биометрия)

2. **Управление реле** (открытие/закрытие дверей)
   - Открытие двери на определенное время
   - Закрытие двери
   - Управление несколькими реле

3. **Отображение сообщений**
   - Текстовые сообщения пользователю
   - Интерактивные сообщения (для POCKET/JSP)
   - Звуковые сигналы

4. **Отчеты о проходе** (`pass_report`)
   - Подтверждение прохода через дверь
   - Время прохода
   - Статус прохода

## Интеграция с системой

Все протоколы интегрированы через:

- **Connection Pool** (`internal/connection/pool.go`)
  - Управление TCP соединениями
  - Маршрутизация данных по типу протокола
  - Обработка переподключений

- **Session Manager** (`internal/session/manager.go`)
  - Создание сессий доступа
  - Обработка стадий доступа (KPO → CAM → PASS)
  - Отправка команд контроллерам

- **HTTP Client** (`internal/httpclient/client.go`)
  - Проверка доступа через 1C
  - Отправка отчетов о проходах

## Типы терминалов

В системе определены следующие типы терминалов:

```go
const (
    TTYPE_GAT    TerminalType = "gat"    // GAT контроллеры
    TTYPE_POCKET TerminalType = "pocket" // POCKET контроллеры
    TTYPE_SPHINX TerminalType = "sphinx"  // SPHINX контроллеры
    TTYPE_JSP    TerminalType = "jsp"     // JSP контроллеры
)
```

## Типичный поток работы

1. **Подключение контроллера**
   ```
   Контроллер → TCP соединение → Connection Pool
   ```

2. **Чтение карты**
   ```
   Контроллер → tag_read → Session Manager → HTTP Client (1C)
   ```

3. **Проверка доступа**
   ```
   1C → результат → Session Manager → команда контроллеру
   ```

4. **Управление дверью**
   ```
   Session Manager → relay_open → Контроллер → дверь открыта
   ```

5. **Отчет о проходе**
   ```
   Контроллер → pass_report → Session Manager → HTTP Client (отчет в 1C)
   ```

## Добавление нового протокола

Для добавления нового протокола контроллера:

1. Создать файл `internal/protocols/<name>/protocol.go`
2. Реализовать функции:
   - `DecodePacket(data []byte) (*Packet, error)` - декодирование пакета
   - `EncodePacket(packet *Packet) ([]byte, error)` - кодирование пакета
3. Добавить обработку в `internal/connection/pool.go`:
   - `process<Name>Data(conn *Connection)`
   - `handle<Name>Packet(conn *Connection, data []byte)`
4. Добавить константу типа терминала в `pkg/types/types.go`
5. Обновить документацию

## Примеры использования

### Отправка команды открытия двери

```go
// Для POCKET
packet := pocket.EncodeRelayControl(uid, message, timeMs, flags)
pool.Send(connKey, packet)

// Для JSP
packet := jsp.EncodeRelayOpen(uid, message, timeMs, cid)
pool.Send(connKey, packet)

// Для GAT
packet := gat.EncodePacket(addr, cmd, result, message)
pool.Send(connKey, packet)
```

### Обработка чтения карты

```go
// В processData определяется тип протокола
switch conn.Settings.Type {
case types.TTYPE_POCKET:
    cp.processPocketData(conn)
case types.TTYPE_JSP:
    cp.processJSPData(conn)
case types.TTYPE_GAT:
    cp.processGatData(conn)
case types.TTYPE_SPHINX:
    cp.processSphinxData(conn)
}
```

## Примечания

- Все протоколы работают через TCP соединения
- Каждый контроллер имеет уникальный идентификатор (ID)
- Поддерживается автоматическое переподключение при разрыве связи
- Для JSP протокола реализован auto-ping для проверки соединения
- Все протоколы поддерживают UTF-8 кодировку для сообщений

